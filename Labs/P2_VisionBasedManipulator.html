
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üî¨ P2: Vision-Based Control &#8212; Fundamentals of Robotics</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet">
  <link href="../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/tabs.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="üêç No Pointer in Python?" href="NoPointer.html" />
    <link rel="prev" title="‚ùÑÔ∏è Lab3: Camera Calibration" href="Lab3_CameraCalibration.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/ece487.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Fundamentals of Robotics</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../intro.html">
   ECE 487 Fundamentals of Robotics
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Course Info
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../syllabus.html">
   üìå Syllabus
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../schedule.html">
   üìÜ Course Schedule
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../resources.html">
   üíé Resources
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../python.html">
   üêç Python Tutorials
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../robots.html">
   ü§ñ Robots, Robots, and Robots
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Labs
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="SoftwareConfiguration.html">
   ‚úîÔ∏è Preflight: Software Setup
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="ICE1_PythonIntro.html">
   ‚ùÑÔ∏è ICE1: Introduction to Python
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="ICE2_PythonContainers.html">
   ‚ùÑÔ∏è ICE2: Containers &amp; Numpy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Lab1_ExtractingEulerAngles.html">
   üî¨ Lab1: Extracting Euler Angles
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="ICE3_OOP.html">
   ‚ùÑÔ∏è ICE3: Classes and Objects
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="ICE4_SpatialMath.html">
   ‚ùÑÔ∏è ICE4: Spatial Math for Python
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="ICE5_RoboticsToolbox.html">
   ‚ùÑÔ∏è ICE5: Robotics Toolbox
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Lab2_ForwardKinematics.html">
   üî¨ Lab2: Forward Kinematics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="P1_InverseKinematics.html">
   üî¨ Project1: Inverse Kinematics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="ICE6_LSE.html">
   ‚ùÑÔ∏è ICE6: Least Squares
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Lab3_CameraCalibration.html">
   ‚ùÑÔ∏è Lab3: Camera Calibration
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   üî¨ P2: Vision-Based Control
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Supplementary
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="NoPointer.html">
   üêç No Pointer in Python?
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Extra.html">
   Supplimentary
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/Labs/P2_VisionBasedManipulator.md"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.md</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
                onclick="printPdf(this)" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/stanbaek/ece487"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/stanbaek/ece487/issues/new?title=Issue%20on%20page%20%2FLabs/P2_VisionBasedManipulator.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#objectives">
   Objectives
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#procedure">
   Procedure
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#search-for-blocks">
     Search for Blocks
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#deliverable">
   üöö Deliverable
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#deliverable-1-10-points">
     Deliverable 1 (10 points)
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#deliverable-2-40-points">
     Deliverable 2 (40 points)
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#deliverable-3-30-points">
     Deliverable 3 (30+ points)
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#deliverable-4-20-points">
     Deliverable 4 (20 points)
    </a>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>üî¨ P2: Vision-Based Control</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#objectives">
   Objectives
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#procedure">
   Procedure
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#search-for-blocks">
     Search for Blocks
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#deliverable">
   üöö Deliverable
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#deliverable-1-10-points">
     Deliverable 1 (10 points)
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#deliverable-2-40-points">
     Deliverable 2 (40 points)
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#deliverable-3-30-points">
     Deliverable 3 (30+ points)
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#deliverable-4-20-points">
     Deliverable 4 (20 points)
    </a>
   </li>
  </ul>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="p2-vision-based-control">
<h1>üî¨ P2: Vision-Based Control<a class="headerlink" href="#p2-vision-based-control" title="Permalink to this headline">¬∂</a></h1>
<div class="section" id="objectives">
<h2>Objectives<a class="headerlink" href="#objectives" title="Permalink to this headline">¬∂</a></h2>
<p>The purpose of this project is to control the robotic arm using computer vision.</p>
<p>In this project, you will</p>
<ul class="simple">
<li><p>Use OpenMV camera to detect, identify, and localize multiple AprilTags.</p></li>
<li><p>Write a Python script to search for blocks and find the locations of the blocks using the AprilTags attached on them.</p></li>
<li><p>Write a Python script for the robotic arm to move the blocks.</p></li>
</ul>
<a class="reference internal image-reference" href="../_images/AprilTagBlocks.jpg"><img alt="../_images/AprilTagBlocks.jpg" class="align-center" src="../_images/AprilTagBlocks.jpg" style="width: 500px;" /></a>
</div>
<div class="section" id="procedure">
<h2>Procedure<a class="headerlink" href="#procedure" title="Permalink to this headline">¬∂</a></h2>
<div class="section" id="search-for-blocks">
<h3>Search for Blocks<a class="headerlink" href="#search-for-blocks" title="Permalink to this headline">¬∂</a></h3>
<p>We need to search for blocks with AprilTags using the OpenMV cammera attached to the robotic arm. Add the following code to the constructor (<code class="docutils literal notranslate"><span class="pre">def</span> <span class="pre">--init__(...)</span></code>) into your <code class="docutils literal notranslate"><span class="pre">xArm.py</span></code></p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span>        <span class="bp">self</span><span class="o">.</span><span class="n">B0</span> <span class="o">=</span> <span class="mf">0.090</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">L1</span> <span class="o">=</span> <span class="mf">0.010</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">L2</span> <span class="o">=</span> <span class="mf">0.105</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">L3</span> <span class="o">=</span> <span class="mf">0.088</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">L4</span> <span class="o">=</span> <span class="mf">0.170</span>
        <span class="c1">#self.camera_distance = 0.133 # distance of OpenMV cam from Joint5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">camera_dist_offset</span> <span class="o">=</span> <span class="mf">0.037</span>  <span class="c1"># L4 - camera_distance</span>
        
                
        
        <span class="c1"># ADD this for OpenMV Cam</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mvcam</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curr_joint_angles</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="c1"># dictionary for block locations</span>
        <span class="c1"># for short tutorial for Python dictionary, visit https://www.w3schools.com/python/python_dictionaries.asp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block_locations</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
</pre></div>
</div>
<p>Add the following <code class="docutils literal notranslate"><span class="pre">Tag</span></code> class before <code class="docutils literal notranslate"><span class="pre">class</span> <span class="pre">XArm(rbt.DHRobot):</span></code></p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Tag</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Data structure for AprilTag</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">x</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">y</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">z</span><span class="p">:</span> <span class="nb">float</span>
                
<span class="k">class</span> <span class="nc">XArm</span><span class="p">(</span><span class="n">rbt</span><span class="o">.</span><span class="n">DHRobot</span><span class="p">):</span>
</pre></div>
</div>
<p>Add the following two functions into your <a class="reference external" href="http://xArm.py">xArm.py</a>.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">connect_mvcam</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mvcam</span><span class="p">,</span> <span class="n">serial</span><span class="o">.</span><span class="n">Serial</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The robot is already connected to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">ports</span> <span class="o">=</span> <span class="n">list_ports</span><span class="o">.</span><span class="n">comports</span><span class="p">()</span>
        <span class="n">comport</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">port</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">hwid</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ports</span><span class="p">):</span>
            <span class="k">if</span> <span class="s1">&#39;OpenMV Cam&#39;</span> <span class="ow">in</span> <span class="n">desc</span><span class="p">:</span>
                <span class="n">comport</span> <span class="o">=</span> <span class="n">port</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Info: OpenMV Cam is connected to&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2"> [</span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">hwid</span><span class="p">))</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="n">comport</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: Serial port for OpenMV is not available.&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;OpenMV Cam is not connected.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># A serial port is found.  Try to connect.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mvcam</span> <span class="o">=</span> <span class="n">serial</span><span class="o">.</span><span class="n">Serial</span><span class="p">(</span>
                <span class="n">port</span><span class="o">=</span><span class="n">comport</span><span class="p">,</span>
                <span class="n">baudrate</span><span class="o">=</span><span class="mi">115200</span><span class="p">,</span>
                <span class="n">parity</span><span class="o">=</span><span class="n">serial</span><span class="o">.</span><span class="n">PARITY_NONE</span><span class="p">,</span>
                <span class="n">stopbits</span><span class="o">=</span><span class="n">serial</span><span class="o">.</span><span class="n">STOPBITS_ONE</span><span class="p">,</span>
                <span class="n">bytesize</span><span class="o">=</span><span class="n">serial</span><span class="o">.</span><span class="n">EIGHTBITS</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="mf">0.01</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Info: OpenMV is connected to </span><span class="si">{</span><span class="n">comport</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">serial</span><span class="o">.</span><span class="n">SerialException</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: Serial port is not available.&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;OpenMV is not connected.&quot;</span><span class="p">)</span>
            
            
    <span class="k">def</span> <span class="nf">search_for_blocks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">duration_ms</span><span class="p">,</span> <span class="n">pose</span><span class="p">,</span> <span class="n">steps</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Search for blocks with AprilTags.</span>
<span class="sd">        The robotic arm will be moved from the current pose to pose (argument) for duration_ms.</span>
<span class="sd">        During the transition from the current pose to the desired pose, the robot will stop moving to search</span>
<span class="sd">        for blocks. The number of stops during the transition is given by the steps argument.</span>
<span class="sd">        Once it finds a block, it will calculate the pose of the block wrt Frame 0 using the</span>
<span class="sd">        current joint angles and the position of the block wrt to the camera frame. Then, it will update</span>
<span class="sd">        self.block_locations with the pose of the block wrt Frame 0.</span>
<span class="sd">        If a block is detected multiple times, self.block_locations will be updated with the latest location.</span>
<span class="sd">        :param duration_ms: time in milliseconds to travel from the current</span>
<span class="sd">        position to the desired position.</span>
<span class="sd">        :param pose: 1x5 array of the pose of the tooltip.</span>
<span class="sd">        The first three elements are the position of the tooltip in meters,</span>
<span class="sd">        and the last two elements are the wrist angles in radians.</span>
<span class="sd">        :param steps: the number of stops during the transition</span>
<span class="sd">        :return: None</span>

<span class="sd">        Example:</span>
<span class="sd">        robot = XArm(simulation_only=False)</span>
<span class="sd">        robot.connect_mvcam()</span>
<span class="sd">        robot.connect()</span>

<span class="sd">        duration_ms = 2000</span>
<span class="sd">        steps = 20</span>

<span class="sd">        robot.move_to_initial_pose(duration_ms)</span>
<span class="sd">        pose = (0.12, -0.15, 0.12, -pi/4, 0)</span>
<span class="sd">        robot.search_for_blocks(duration_ms, pose, steps)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">joint_angles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">invkine</span><span class="p">(</span><span class="n">pose</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">joint_angles</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No solution to inverse kinematics for &quot;</span><span class="p">,</span> <span class="n">pose</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">angle_step</span> <span class="o">=</span> <span class="p">(</span><span class="n">joint_angles</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_joint_angles</span><span class="p">)</span><span class="o">/</span><span class="n">steps</span>
        <span class="n">dtime_ms</span> <span class="o">=</span> <span class="n">duration_ms</span><span class="o">//</span><span class="n">steps</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">steps</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">curr_joint_angles</span> <span class="o">+=</span> <span class="n">angle_step</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">move_joints</span><span class="p">(</span><span class="n">dtime_ms</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">curr_joint_angles</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># print(np.rad2deg(self.curr_joint_angles))</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mvcam</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">num_tags</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_tags</span><span class="p">):</span>
                <span class="n">tagid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="o">*</span><span class="n">i</span><span class="p">])</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="o">+</span><span class="mi">4</span><span class="o">*</span><span class="n">i</span><span class="p">])</span>

                <span class="sd">&quot;&quot;&quot; Write your code to find the location of the block wrt the </span>
<span class="sd">                inertial reference frame, Frame {0}</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="c1"># Find the transformation matrix of Tool Frame wrt Frame 0</span>
                <span class="c1"># Hint: You need only one line of code here</span>
                
                
                <span class="c1"># Find the transformation matrix of the block wrt Frame 0</span>
                <span class="c1"># Hint: you need only one line of code (Look at Lab1)</span>
                
                
                <span class="c1"># Add the location (translation, or the x-,y-,z-coordinates) of the block.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">block_locations</span><span class="p">[</span><span class="n">tagid</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># replace 0 with the location of the block.  </span>
                
            <span class="c1"># comment out the following line if you don&#39;t want to print    </span>
            <span class="p">[</span><span class="nb">print</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="s1">&#39;, &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_locations</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_locations</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
</pre></div>
</div>
<p>Complete the search_for_blocks function. Use the following code to test the function.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_search_for_blocks</span><span class="p">():</span>

    <span class="c1"># Set simulation_only=True to test the OpenMV cam.</span>
    <span class="c1"># Set it False to test the camera while the robot is moving.    </span>
    <span class="n">robot</span> <span class="o">=</span> <span class="n">XArm</span><span class="p">(</span><span class="n">simulation_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">robot</span><span class="o">.</span><span class="n">connect_mvcam</span><span class="p">()</span>
    <span class="n">robot</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>

    <span class="n">duration_ms</span> <span class="o">=</span> <span class="mi">2000</span>
    <span class="n">steps</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># pick a number for steps.</span>

    <span class="n">robot</span><span class="o">.</span><span class="n">move_to_initial_pose</span><span class="p">(</span><span class="n">duration_ms</span><span class="p">)</span>
    
    <span class="n">pose</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># pick the start pose for searching </span>
    <span class="n">robot</span><span class="o">.</span><span class="n">moveto</span><span class="p">(</span><span class="n">duration_ms</span><span class="p">,</span> <span class="n">pose</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">pose</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># pick the destination pose for searching</span>
    <span class="n">robot</span><span class="o">.</span><span class="n">search_for_blocks</span><span class="p">(</span><span class="n">duration_ms</span><span class="p">,</span> <span class="n">pose</span><span class="p">,</span> <span class="n">steps</span><span class="p">)</span>
    
    <span class="n">pose</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># pick the next destination pose for searching</span>
    <span class="n">robot</span><span class="o">.</span><span class="n">search_for_blocks</span><span class="p">(</span><span class="n">duration_ms</span><span class="p">,</span> <span class="n">pose</span><span class="p">,</span> <span class="n">steps</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="deliverable">
<h2>üöö Deliverable<a class="headerlink" href="#deliverable" title="Permalink to this headline">¬∂</a></h2>
<div class="section" id="deliverable-1-10-points">
<h3>Deliverable 1 (10 points)<a class="headerlink" href="#deliverable-1-10-points" title="Permalink to this headline">¬∂</a></h3>
<p>Your code should be able to find and identify blocks placed at,</p>
<ul class="simple">
<li><p>(22, 0, 0)</p></li>
<li><p>(30, 0, 0)</p></li>
<li><p>(19, -10, 0)</p></li>
<li><p>(26, -11, 0)</p></li>
<li><p>(25, 18, 0)</p></li>
</ul>
<p><strong>Report the console output printed by the following code inside <code class="docutils literal notranslate"><span class="pre">search_for_blocks</span></code>.</strong></p>
<p><code class="docutils literal notranslate"><span class="pre">[print(key,</span> <span class="pre">',</span> <span class="pre">',</span> <span class="pre">self.block_locations[key])</span> <span class="pre">for</span> <span class="pre">key</span> <span class="pre">in</span> <span class="pre">self.block_locations.keys()]</span></code></p>
</div>
<div class="section" id="deliverable-2-40-points">
<h3>Deliverable 2 (40 points)<a class="headerlink" href="#deliverable-2-40-points" title="Permalink to this headline">¬∂</a></h3>
<p>As you can find, the localization accuracy is sometimes very poor depending highly on where the block is located in the image frame. If the block is at the center of the image frame, it is usually pretty accurate. If the block is located at the corner or side of the image frame, it has a large error. How would you improve the accuracy?</p>
<p>A few ideas that you may want to consider (not necessarily good ideas)</p>
<ul class="simple">
<li><p>Average out all the measurements</p></li>
<li><p>Based on the locations you initially have, move the arm where a block can be located at the center of the image frame, and retake a measurement.</p></li>
</ul>
<p><strong>Report the following in your final report</strong></p>
<ul class="simple">
<li><p>Implementation of your idea in <a class="reference external" href="http://xArm.py">xArm.py</a>.  You can modify the <code class="docutils literal notranslate"><span class="pre">search_for_blocks</span></code> method or create your own method.</p></li>
<li><p>Justification of the idea.</p></li>
<li><p>Measurements.</p></li>
<li><p>Analysis of your data.</p></li>
</ul>
<p>In the real engineering world, there are always multiple solutions available. There is no right or wrong solution, but there are better solutions. I would like to see your ideas, implementation, justification, and analysis.</p>
</div>
<div class="section" id="deliverable-3-30-points">
<h3>Deliverable 3 (30+ points)<a class="headerlink" href="#deliverable-3-30-points" title="Permalink to this headline">¬∂</a></h3>
<p><strong>Demo (30 pts):</strong> Search for a block with AprilTag ID 0 (let‚Äôs call it Block 0) and Block 1, and place Block 0 on top of Block 1.</p>
<p>The blocks are placed anywhere near the five locations (<span class="math notranslate nohighlight">\(\pm 5\)</span> cm) in Deliverable 1.</p>
<p><strong>Demo (3 - 7 bonus pts):</strong> Move multiple blocks (Blocks 0 - 3) on top of Block 4.</p>
<ul class="simple">
<li><p>2 blocks: + 3 points</p></li>
<li><p>3 blocks: + 5 points</p></li>
<li><p>3 blocks: + 7 points</p></li>
</ul>
</div>
<div class="section" id="deliverable-4-20-points">
<h3>Deliverable 4 (20 points)<a class="headerlink" href="#deliverable-4-20-points" title="Permalink to this headline">¬∂</a></h3>
<p><strong>Submit final report.</strong></p>
<p>Your report should include the following sections or similar:</p>
<ul class="simple">
<li><p>Objective</p></li>
<li><p>Methods</p></li>
<li><p>Results and Analyses</p></li>
<li><p>Conclusion</p></li>
</ul>
<p>There are no requirements for font size, page margins, number of pages, etc. Write a professional, senior-level report.
Do not use <em>you</em> in your report.<br />
Hint: I love figures and tables as long as they are legible.</p>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./Labs"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="Lab3_CameraCalibration.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">‚ùÑÔ∏è Lab3: Camera Calibration</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="NoPointer.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">üêç No Pointer in Python?</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By Stan Baek<br/>
    
        &copy; Copyright 2022.<br/>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>